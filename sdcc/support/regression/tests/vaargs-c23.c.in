/** Tests argument passing to functions via va_args.
    Assumes that up to the first two arguments can be passed in registers.

    type1: va_char, int, long
    type2: va_char, int, long
    type3: va_char, int, long
 */
#include <testfwk.h>
#include <stdarg.h>

#pragma std_c23

#if (__STDC_VERSION_STDARG_H__ >= 202311L)

#if defined(__SDCC_mcs51) || defined (__SDCC_ds390) || defined (__SDCC_mos6502) || defined (__SDCC_mos65c02) || defined (__SDCC_pic14) || defined (__SDCC_pic16)
# define va_char char
#else
# define va_char int
#endif

#ifndef __SDCC_pic16
static {type1}
returnFirstArg(...)
{
    va_list ap;
    {type1} i;

    va_start(ap);
    i = va_arg(ap, {type1});

    va_end(ap);

    LOG(("Returning %d\n", i));
    return i;
}

static {type2}
returnSecondArg(...)
{
    va_list ap;
    {type2} i;

    va_start(ap);
    UNUSED(va_arg(ap, {type1}));
    i = va_arg(ap, {type2});

    va_end(ap);

    LOG(("Returning %d\n", i));
    return i;
}

#if !defined( __SDCC_pdk13) && !defined( __SDCC_pdk14) // Lack of memory
static {type2}
returnSecondArgCopy(...)
{
    va_list ap1, ap2;
    {type2} i;

    va_start(ap1);
    UNUSED(va_arg(ap1, {type1}));
    va_copy(ap2, ap1);
    i = va_arg(ap2, {type2});

    va_end(ap1);
    va_end(ap2);

    LOG(("Returning %d\n", i));
    return i;
}

static {type3}
returnThirdArg(...)
{
    va_list ap;
    {type3} i;

    va_start(ap);
    UNUSED(va_arg(ap, {type1}));
    UNUSED(va_arg(ap, {type2}));
    i = va_arg(ap, {type3});

    va_end(ap);

    LOG(("Returning %d\n", i));
    return i;
}
#endif
#endif
#endif

void
testArgs(void)
{
#if (__STDC_VERSION_STDARG_H__ >= 202311L)
#ifndef __SDCC_pic16
    LOG(("First arg: %u\n", returnFirstArg(({type1})123, ({type2})45, ({type3})67)));
    ASSERT(returnFirstArg(({type1})123, ({type2})45, ({type3})67) == ({type1})123);
    ASSERT(returnFirstArg(({type1})-123, ({type2})45, ({type3})67) == ({type1})-123);
#if !defined( __SDCC_pdk13) && !defined( __SDCC_pdk14) // Lack of memory
    ASSERT(returnSecondArg(({type1})1, ({type2})-23, ({type3})64) == ({type2})-23);
    ASSERT(returnSecondArg(({type1})1, ({type2})8, ({type3})64) == ({type2})8);
    
    ASSERT(returnSecondArgCopy(({type1})1, ({type2})-23, ({type3})64) == ({type2})-23);
    ASSERT(returnSecondArgCopy(({type1})1, ({type2})8, ({type3})64) == ({type2})8);

    ASSERT(returnThirdArg(({type1})-33, ({type2})-34, ({type3})-35) == ({type3})-35);
    ASSERT(returnThirdArg(({type1})-33, ({type2})-34, ({type3})35) == ({type3})35);
#endif
#endif
#endif
}

